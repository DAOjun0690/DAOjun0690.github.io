<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>卡厄斯計分模擬器 (多角色單頁版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 1200px; /* 擴大容器以容納三個角色 */
        }
        .card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        /* 隱藏數字輸入欄位的微調按鈕 */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .control-button {
             /* 階級控制按鈕樣式 */
            @apply w-10 h-10 flex items-center justify-center bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition duration-150 text-2xl font-bold p-1 leading-none active:scale-95;
        }
        .count-button {
            /* 操作次數控制按鈕樣式 */
            @apply w-8 h-8 flex items-center justify-center bg-indigo-200 text-indigo-800 rounded-lg hover:bg-indigo-300 transition duration-150 text-xl font-bold p-1 leading-none active:scale-95;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="container mx-auto">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-8 text-center">
            卡厄斯計分模擬器
        </h1>
        
        <!-- 階級和上限分數區域 (共用) -->
        <div class="card bg-white p-6 rounded-xl mb-8 border-t-4 border-indigo-500">
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6 items-center">
                
                <!-- 階級輸入 (共用) -->
                <div class="flex flex-col col-span-1 md:col-span-2 lg:col-span-2">
                    <label for="tier-input" class="text-sm font-medium text-gray-600 mb-1">
                        存檔資料價值 <span class="text-red-500">(TIER)</span>
                    </label>
                    <div class="flex items-center space-x-2">
                        <!-- 減號按鈕 -->
                        <button type="button" onclick="decrementTier()" 
                                class="control-button">
                                &minus;
                        </button>
                        <input type="number" id="tier-input" value="1" min="1" max="14"
                           class="w-full p-3 border-2 border-indigo-300 rounded-lg focus:border-indigo-500 focus:ring-indigo-500 text-lg font-semibold text-center transition duration-150 ease-in-out"
                           oninput="handleTierChange()">
                        <!-- 加號按鈕 -->
                        <button type="button" onclick="incrementTier()" 
                                class="control-button">
                                +
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">基礎 30pt，每 1 階多 10pt。</p>
                </div>

                <!-- 上限分數顯示 (共用階級決定) -->
                <div class="p-4 bg-indigo-50 rounded-lg text-center">
                    <p class="text-sm font-medium text-indigo-700">階級分數上限</p>
                    <p id="max-limit" class="text-3xl font-extrabold text-indigo-900 mt-1">30 pt</p>
                </div>
                
                <!-- 空白佔位符 -->
                <div class="hidden lg:block"></div> 

            </div>
        </div>

        <!-- 三個角色的計分項目輸入區域 (並排顯示) -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- 角色 1 -->
            <div id="char1-container" class="card bg-white p-6 rounded-xl border-t-4 border-gray-400">
                <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800">角色 1</h2>
                </div>

                <!-- 警告/狀態訊息 (獨立) -->
                <div id="status-message-char1" class="mb-4 p-3 rounded-lg text-center font-semibold transition-all duration-300 bg-green-100 text-green-700">
                    目前總分：清晰
                </div>

                <!-- 輸入欄位容器 -->
                <div id="input-fields-char1" class="grid grid-cols-2 gap-4">
                </div>

                <div class="mt-4 pt-4 border-t border-gray-100 flex justify-center">
                    <button type="button" onclick="resetCharacterCounts('char1')" 
                        class="px-4 py-2 text-sm font-semibold text-red-600 bg-red-100 rounded-lg hover:bg-red-200 transition duration-150 active:scale-95">
                        重置角色 1 計數
                    </button>
                </div>
            </div>

            <!-- 角色 2 -->
            <div id="char2-container" class="card bg-white p-6 rounded-xl border-t-4 border-gray-400">
                <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800">角色 2</h2>
                </div>

                <!-- 警告/狀態訊息 (獨立) -->
                <div id="status-message-char2" class="mb-4 p-3 rounded-lg text-center font-semibold transition-all duration-300 bg-green-100 text-green-700">
                    目前總分：清晰
                </div>

                <!-- 輸入欄位容器 -->
                <div id="input-fields-char2" class="grid grid-cols-2 gap-4">
                </div>

                <div class="mt-4 pt-4 border-t border-gray-100 flex justify-center">
                    <button type="button" onclick="resetCharacterCounts('char2')" 
                        class="px-4 py-2 text-sm font-semibold text-red-600 bg-red-100 rounded-lg hover:bg-red-200 transition duration-150 active:scale-95">
                        重置角色 2 計數
                    </button>
                </div>
            </div>

            <!-- 角色 3 -->
            <div id="char3-container" class="card bg-white p-6 rounded-xl border-t-4 border-gray-400">
                <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800">角色 3</h2>
                </div>

                <!-- 警告/狀態訊息 (獨立) -->
                <div id="status-message-char3" class="mb-4 p-3 rounded-lg text-center font-semibold transition-all duration-300 bg-green-100 text-green-700">
                    目前總分：清晰
                </div>

                <!-- 輸入欄位容器 -->
                <div id="input-fields-char3" class="grid grid-cols-2 gap-4">
                </div>

                <div class="mt-4 pt-4 border-t border-gray-100 flex justify-center">
                    <button type="button" onclick="resetCharacterCounts('char3')" 
                        class="px-4 py-2 text-sm font-semibold text-red-600 bg-red-100 rounded-lg hover:bg-red-200 transition duration-150 active:scale-95">
                        重置角色 3 計數
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 點數表說明 -->
        <p class="text-xs text-gray-500 mt-6 text-center">
            計分規則來自試算表數據：1-4 次數採用累進點數，5 次以上皆使用 5+ 的點數。
            <br>
            <span class="font-semibold text-gray-600">中立卡、禁忌卡片皆採用 [20, 40, 60, 80, 100] 的累進點數。</span>
        </p>

    </div>

    <script>
        // 核心計分規則表
        const POINT_TABLE = {
            "刪除卡片": [0, 10, 40, 90, 160], // Max 160
            "刪除角色": [20, 40, 60, 80, 100],
            "轉化卡片": [10, 20, 30, 40, 50],
            "複製卡片": [0, 10, 40, 90, 160], // Max 160
            "中立卡片": [20, 40, 60, 80, 100], 
            "怪物卡片": [80, 160, 240, 320, 400], // Max 400
            "神閃卡片": [20, 40, 60, 80, 100],
            "中立普閃": [10, 20, 30, 40, 50],
            "禁忌卡片": [20, 40, 60, 80, 100]
        };

        const actionNames = Object.keys(POINT_TABLE);
        const characterIds = ['char1', 'char2', 'char3'];

        // 儲存所有角色的數據：只儲存操作次數
        let characterData = {};
        
        // 共用階級變數
        let sharedTier = 1; 
        const MAX_TIER = 14; 
        const MIN_TIER = 1;

        // DOM 元素引用
        const tierInput = document.getElementById('tier-input');
        const maxLimitEl = document.getElementById('max-limit');
        
        // --- 狀態管理函數 ---

        // 1. 初始化所有角色的數據
        function initializeCharacterData() {
            characterIds.forEach((id) => {
                characterData[id] = {
                    counts: {} 
                };
                actionNames.forEach(name => {
                    characterData[id].counts[name] = 0;
                });
            });
            tierInput.value = sharedTier;
        }
        
        /**
         * 2. 核心計分函數 (所有項目皆為累進點數陣列)
         * @param {string} actionName - 操作名稱
         * @param {number|string} count - 操作次數
         * @returns {number} 該操作應得的分數
         */
        function getPointsForAction(actionName, count) {
            const pointsRule = POINT_TABLE[actionName];
            if (!pointsRule || !Array.isArray(pointsRule)) return 0;
            
            // 確保次數為有效的非負整數
            const validCount = Math.max(0, parseInt(count) || 0);

            if (validCount === 0) {
                return 0;
            }
            
            // 處理累進計分項目
            if (validCount >= 5) {
                return pointsRule[4]; // 次數 5+ 的點數 (索引 4)
            } else {
                return pointsRule[validCount - 1]; // 次數 1-4 (索引 0-3)
            }
        }

        /**
         * 3. 計算指定角色的總分
         * @param {string} charId - 角色 ID
         * @returns {number} 該角色的總分數
         */
        function calculateTotalScore(charId) {
            let totalScore = 0;
            const currentCounts = characterData[charId].counts;
            
            actionNames.forEach(name => {
                const count = currentCounts[name] || 0;
                // 確保累加的是數字
                totalScore += getPointsForAction(name, count);
            });

            return totalScore;
        }

        // 4. 計算階級上限 (14 階最高 160pt)
        function calculateMaxLimit(tier) {
            const base = 30;
            const perTierBonus = 10;
            const validTier = Math.max(1, parseInt(tier) || 1);
            
            if (validTier >= MAX_TIER) {
                // 14 階上限 (30 + (14 - 1) * 10 = 160pt)
                return 160; 
            }

            return base + (validTier - 1) * perTierBonus;
        }

        // 5. 重置指定角色的所有操作次數
        function resetCharacterCounts(charId) {
            if (!charId || !characterData[charId]) return;

            // 1. 重置數據
            actionNames.forEach(name => {
                characterData[charId].counts[name] = 0;
            });

            // 2. 更新 UI 欄位
            createInputFields(charId);

            // 3. 重新計算並顯示分數
            updateCharacterScoreDisplay(charId);
        }

        // --- UI 更新與事件處理函數 ---
        
        // 增加階級 (共用)
        function incrementTier() {
            if (sharedTier < MAX_TIER) {
                sharedTier++;
                tierInput.value = sharedTier;
                updateAllScoreDisplays(); // 階級變更，所有角色都要更新
            }
        }

        // 減少階級 (共用)
        function decrementTier() {
            if (sharedTier > MIN_TIER) {
                sharedTier--;
                tierInput.value = sharedTier;
                updateAllScoreDisplays(); // 階級變更，所有角色都要更新
            }
        }

        // 處理操作次數輸入變更 (手動輸入或按鈕觸發)
        function handleCountChange(charId, actionName, inputElement) {
            // 確保輸入值是有效的數字，若為空或非數字則視為 0
            const count = Math.max(0, parseInt(inputElement.value) || 0);
            inputElement.value = count; // 將修正後的值寫回輸入框，避免負數

            // 更新指定角色的狀態
            characterData[charId].counts[actionName] = count;
            
            updateCharacterScoreDisplay(charId);
        }

        // 增加次數
        function incrementCount(charId, actionName) {
            // ID 變更為 charId-actionName
            const inputEl = document.getElementById(`${charId}-${actionName}`);
            let count = parseInt(inputEl.value) || 0;
            count++;
            inputEl.value = count;
            handleCountChange(charId, actionName, inputEl); 
        }

        // 減少次數
        function decrementCount(charId, actionName) {
            // ID 變更為 charId-actionName
            const inputEl = document.getElementById(`${charId}-${actionName}`);
            let count = parseInt(inputEl.value) || 0;
            if (count > 0) {
                count--;
                inputEl.value = count;
                handleCountChange(charId, actionName, inputEl); 
            }
        }

        // 處理階級輸入變更 (手動輸入)
        function handleTierChange() {
            let tier = parseInt(tierInput.value) || MIN_TIER;
            // 限制輸入範圍
            tier = Math.max(MIN_TIER, Math.min(MAX_TIER, tier));
            
            // 更新共用階級狀態
            sharedTier = tier;
            tierInput.value = sharedTier; 

            updateAllScoreDisplays();
        }
        
        // 產生指定角色的輸入欄位並載入數據
        function createInputFields(charId) {
            const container = document.getElementById(`input-fields-${charId}`);
            if (!container) return;
            
            container.innerHTML = '';
            const currentCounts = characterData[charId].counts;

            actionNames.forEach(name => {
                const count = currentCounts[name] || 0;
                const div = document.createElement('div');
                div.className = 'flex flex-col p-2 bg-gray-50 rounded-lg';
                
                const labelText = name;

                // 引入按鈕
                div.innerHTML = `
                    <label for="${charId}-${name}" class="text-xs font-medium text-gray-700 mb-1 truncate">
                        ${labelText}
                    </label>
                    <div class="flex items-center space-x-1">
                        <button type="button" onclick="decrementCount('${charId}', '${name}')" 
                                class="count-button">
                                &minus;
                        </button>
                        <input type="number" id="${charId}-${name}" value="${count}" min="0" 
                               class="w-full p-2 border border-gray-300 rounded-md text-base text-center font-mono focus:border-indigo-500 focus:ring-indigo-500"
                               oninput="handleCountChange('${charId}', '${name}', this)">
                        <button type="button" onclick="incrementCount('${charId}', '${name}')" 
                                class="count-button">
                                +
                        </button>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        // 更新單一角色的分數和狀態顯示
        function updateCharacterScoreDisplay(charId) {
            const maxLimit = calculateMaxLimit(sharedTier);
            const totalScore = calculateTotalScore(charId);

            const statusMessageEl = document.getElementById(`status-message-${charId}`);

            // 處理警告狀態
            if (totalScore > maxLimit) {
                statusMessageEl.className = 'mb-4 p-3 rounded-lg text-center font-semibold transition-all duration-300 bg-red-100 text-red-700';
                statusMessageEl.innerHTML = `
                    <span class="text-xl mr-2">⚠️</span> 
                    <span class="text-lg font-bold">${totalScore} pt</span> 超過上限 (${maxLimit} pt)！
                `;
            } else {
                statusMessageEl.className = 'mb-4 p-3 rounded-lg text-center font-semibold transition-all duration-300 bg-green-100 text-green-700';
                statusMessageEl.innerHTML = `
                    <span class="text-xl mr-2">✅</span> 
                    目前總分：<span class="text-lg font-bold">${totalScore} pt</span> / ${maxLimit} pt
                `;
            }
        }
        
        // 更新階級上限顯示 (共用)
        function updateMaxLimitDisplay() {
            const maxLimit = calculateMaxLimit(sharedTier);
            maxLimitEl.textContent = `${maxLimit} pt`;
        }
        
        // 更新所有角色的分數顯示
        function updateAllScoreDisplays() {
            updateMaxLimitDisplay();
            characterIds.forEach(id => {
                updateCharacterScoreDisplay(id);
            });
        }
        
        // --- 初始化 ---

        window.onload = function() {
            initializeCharacterData();
            
            // 1. 為每個角色生成輸入欄位
            characterIds.forEach(id => {
                createInputFields(id);
            });

            // 2. 初始計算與顯示
            updateAllScoreDisplays(); 
        };
    </script>
</body>
</html>